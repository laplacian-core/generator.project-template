{{#*inline "PROPERTY_DEFINITION" ~}}
          "{{lower-snake property.name}}": {
            {{#if property.multiple ~}}
            "type": "array",
            "items": {
            {{/if}}
            {{#if property.domain_type}}
            "allOf": [{
            {{/if}}
            "description": {{json (trim property.description)}},
            {{#if property.domain}}
            {{#if property.domain.pattern}}
            "pattern": "^{{trim property.domain.pattern}}$",
            {{/if}}
            {{#if property.domain.choices ~}}
            "enum":[
              {{#each property.domain.choices as |item|}}
              "{{trim item.value}}"{{#unless @last}},{{/unless}}
              {{/each}}
            ],
            {{/if}}
            {{/if}}
            {{#if property.subtype_key ~}}
            "enum":[
              {{#each property.entity.subtypes as |subtype|}}
              "{{trim subtype.name}}"{{#unless @last}},{{/unless}}
              {{/each}}
            ],
            {{/if}}
            "type": "{{property.type}}"
            {{#if property.domain_type}}
            }, {
            "$ref": "#/definitions/value_domain_types/{{lower-snake property.domain_type.name}}"
            }]
            {{/if}}
            {{#if property.multiple ~}}
            }
            {{/if}}
          }
{{~/inline}}

{{#*inline "ENTITY_DEFINITION" ~}}
      "{{lower-snake entity.name}}": {
        "description": {{json (trim entity.description)}},
        {{#unless entity.subtype_of}}
        "type": "object",
        "required": [
          {{define 'required_props' (case
            (eq mode 'partial') (filter entity.primary_keys '(not @it.optional)')
            (eq mode 'full') (filter entity.stored_properties '(not @it.optional)')
          ) ~}}
          {{#unless (eq mode 'singleton') ~}}
          {{#each required_props as |property| ~}}
          "{{lower-snake property.name}}"{{#unless @last}},{{/unless}}
          {{/each}}
          {{/unless}}
        ],
        {{else}}
        "if": { "properties": {
          "{{lower-snake entity.supertype.subtype_key.name}}": { "const": {{json entity.subtype_key_value}} }
        }},
        "then": {
        {{/unless}}
        {{#unless entity.subtypes ~}}
        "additionalProperties": false,
        {{/unless}}
        "properties": {
          {{#each (filter entity.all_properties "(not @it.snippet)") as |property| ~}}
          {{>PROPERTY_DEFINITION entity=entity property=property }}{{#if (or (not @last) entity.aggregates)}},{{/if}}
          {{/each}}
          {{#each entity.aggregates as |aggregate| ~}}
          "{{lower-snake aggregate.name}}": {
            "description": {{json (trim aggregate.description)}},
            {{#if aggregate.multiple}}
            "type": "array",
            "items": {
              "$ref": "#/definitions/entities/{{lower-snake aggregate.reference_entity.name}}"
            }
            {{else}}
            "$ref": "#/definitions/entities/{{lower-snake aggregate.reference_entity.name}}"
            {{/if}}
          }{{#unless @last}},{{/unless}}
          {{/each}}
        }{{#if entity.subtypes}},
        "allOf": [
          {{#each entity.subtypes as |subtype| ~}}
          { "$ref": "#/definitions/entities/{{lower-snake subtype.name}}" }{{#unless @last}},{{/unless}}
          {{/each}}
        ]
        {{/if}}
        {{#if entity.subtype_of ~}}
        }
        {{/if}}
      }
{{~/inline}}
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Domain model definition for the {{project.name}} project.",
  "description": "Domain model definition for the {{project.name}} project.",
  "type": "object",
  "required": [],
  "properties": {
    {{#each entities.top_level as |entity|}}
    {{#if entity.singly_rooted ~}}
    {{> ENTITY_DEFINITION entity=entity mode='singleton' }}
    {{else}}
    "{{lower-snake (plural entity.name)}}": {
      "description": {{json (trim entity.description)}},
      "type": "array",
      "items": {
        "$ref": "#/definitions/entities/{{lower-snake entity.name}}"
      }
    }
    {{/if}}
    {{~#unless @last}},{{/unless}}
    {{/each}}
  },
  "definitions": {
    "value_domain_types": {
      {{#each value_domain_types as |type|}}
      "{{lower-snake type.name}}": {
        "description": {{json (trim type.description)}},
        {{#if type.domain.pattern}}
        "pattern": {{#dquote}}^{{trim type.domain.pattern}}${{/dquote}},
        {{/if}}
        {{#if type.domain.choices}}
        "enum":[
           {{#each type.domain.choices as |item|}}
           "{{trim item.value}}"{{#unless @last}},{{/unless}}
           {{/each}}
        ],
        {{/if}}
        "type": "{{type.type}}"
      }{{#unless @last}},{{/unless}}
      {{/each}}
    },
    "entities": {
      {{#each entities as |entity| ~}}
      {{> ENTITY_DEFINITION entity=entity}}{{#unless @last}},{{/unless}}
      {{/each}}
    }
  }
}
