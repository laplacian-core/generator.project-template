#!/usr/bin/env bash
set -e
SCRIPT_BASE_DIR=$(cd $"${BASH_SOURCE%/*}" && pwd)
PROJECT_BASE_DIR=$(cd $SCRIPT_BASE_DIR && cd .. && pwd)

TARGET_PROJECT_DIR={{project.target_dir}}
TARGET_MODEL_DIR="$TARGET_PROJECT_DIR/model"
TARGET_PROJECT_MODEL_FILE="$TARGET_MODEL_DIR/{{hyphen project.name}}-project.yaml"

normalize_path () {
  local path=$1
  if [[ $path == /* ]]
  then
    echo $path
  else
    echo "${PROJECT_BASE_DIR}/$path"
  fi
}

mkdir -p $TARGET_MODEL_DIR
cat <<END_FILE > $TARGET_PROJECT_MODEL_FILE
project:
  group: {{project.group}}
  name: {{project.name}}
  namespace: {{project.namespace}}
  {{#if project.version ~}}
  version: '{{project.version}}'
  {{/if}}
  {{#if project.source_repository ~}}
  source_repository:
    url: {{project.source_repository.url}}
    branch: {{project.source_repository.branch}}
  {{/if}}
  subprojects: []
  {{#if project.schemas ~}}
  schemas:
  {{#each project.schemas as |schema| ~}}
  - group: {{schema.group}}
    name: {{schema.name}}
    version: '{{schema.version}}'
  {{/each}}
  {{else}}
  schemas: []
  {{/if}}
  {{#if project.templates ~}}
  templates:
  {{#each project.templates as |template| ~}}
  - group: {{template.group}}
    name: {{template.name}}
    version: '{{template.version}}'
  {{/each}}
  {{else}}
  templates: []
  {{/if}}
  {{#if project.model_files ~}}
  {{#each project.model_files as |files| ~}}
  - $(normalize_path '{{files}}')
  {{/each}}
  {{else}}
  model_files: []
  {{/if}}
  {{#if project.template_files ~}}
  template_files:
  {{#each project.template_files as |files| ~}}
  - $(normalize_path '{{files}}')
  {{/each}}
  {{else}}
  template_files: []
  {{/if}}
END_FILE

GENERATOR_SCRIPT_FILE_NAME={{hyphen project.group}}-{{hyphen project.name}}-generate.sh
TARGET_SCRIPT_DIR="$TARGET_PROJECT_DIR/scripts"
TARGET_PROJECT_GENERATOR_SCRIPT="$TARGET_SCRIPT_DIR/$GENERATOR_SCRIPT_FILE_NAME"

mkdir -p $TARGET_SCRIPT_DIR

{{#if project.source_repository ~}}
if [[ ! -d ./git ]]
then
  git remote add -f {{hyphen project.name}} {{project.source_repository.url}}
  git subtree add --prefix {{project.target_dir}} {{hyphen project.name}} {{project.source_repository.branch}} --squash
fi
{{/if}}

(cd $TARGET_PROJECT_DIR
  if [[ ! -f ./scripts/laplacian-generate.sh ]]
  then
    curl -Ls https://git.io/fhxcl | bash
  fi
  ./scripts/laplacian-project-generate.sh
)

